<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PDF Signature Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Previous styles remain the same */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .upload-section {
            text-align: center;
            padding: 40px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: white;
        }
        
        .pdf-container {
            position: relative;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        #pdfCanvas {
            width: 100%;
            height: auto;
        }
        
        .signature-box {
            position: absolute;
            cursor: move;
            border: 1px solid #ccc;
        }
        
        .signature-box .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border: 1px solid #ccc;
            right: -5px;
            bottom: -5px;
            cursor: se-resize;
        }
        
        .signature-box .delete-btn {
            position: absolute;
            right: -10px;
            top: -10px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
        }
        
        .button:hover {
            background: #0056b3;
        }
        
        #controls {
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-section" id="uploadSection">
            <h2>Upload PDF</h2>
            <input type="file" id="pdfInput" accept=".pdf" style="display: none;">
            <button class="button" onclick="document.getElementById('pdfInput').click()">Choose PDF</button>
        </div>
        
        <div class="pdf-container" id="pdfContainer">
            <canvas id="pdfCanvas"></canvas>
        </div>
        
        <div id="controls">
            <input type="file" id="signatureInput" accept=".jpg,.jpeg,.png" style="display: none;">
            <button class="button" onclick="document.getElementById('signatureInput').click()">Add Signature</button>
            <button class="button" id="downloadBtn">Download PDF</button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let pdfDoc = null;
        let currentPage = 1;
        let scale = 1.5;

        // Function to apply scanner effect to signature
        async function applySignatureScannerEffect(imgSrc) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    // Create canvas for processing
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas size to image size
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw original image
                    ctx.drawImage(img, 0, 0);
                    
                    // Get image data for processing
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Apply scanner-like effects
                    for (let i = 0; i < data.length; i += 4) {
                        // Convert to grayscale
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        
                        // Increase contrast
                        const contrast = 1.5; // Adjust this value to increase/decrease contrast
                        const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                        const newValue = factor * (avg - 128) + 128;
                        
                        // Threshold to make it more black and white
                        const threshold = 160; // Adjust this value to change the black/white cutoff
                        const final = newValue > threshold ? 255 : 0;
                        
                        // Set RGB values
                        data[i] = final;     // R
                        data[i + 1] = final; // G
                        data[i + 2] = final; // B
                        
                        // Keep alpha channel
                        if (data[i + 3] < 200) { // If pixel is somewhat transparent
                            data[i + 3] = 0;     // Make it fully transparent
                        }
                    }
                    
                    // Put processed image data back
                    ctx.putImageData(imageData, 0, 0);
                    
                    // Get processed image as data URL
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = imgSrc;
            });
        }

        // Handle PDF upload (remains the same)
        document.getElementById('pdfInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const typedarray = new Uint8Array(e.target.result);
                    pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                    renderPage(currentPage);
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('pdfContainer').style.display = 'block';
                    document.getElementById('controls').style.display = 'block';
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // Render PDF page (remains the same)
        async function renderPage(pageNum) {
            const page = await pdfDoc.getPage(pageNum);
            const canvas = document.getElementById('pdfCanvas');
            const context = canvas.getContext('2d');
            
            const viewport = page.getViewport({ scale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;
        }

        // Modified signature upload handler
        document.getElementById('signatureInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    // Apply scanner effect before creating signature box
                    const processedImage = await applySignatureScannerEffect(e.target.result);
                    createSignatureBox(processedImage);
                };
                reader.readAsDataURL(file);
            }
        });

        // Create draggable signature box (remains the same)
        function createSignatureBox(imgSrc) {
            const signatureBox = document.createElement('div');
            signatureBox.className = 'signature-box';
            
            const img = document.createElement('img');
            img.src = imgSrc;
            img.style.width = '200px';
            img.style.height = 'auto';
            
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = 'Ã—';
            
            signatureBox.appendChild(img);
            signatureBox.appendChild(resizeHandle);
            signatureBox.appendChild(deleteBtn);
            
            document.getElementById('pdfContainer').appendChild(signatureBox);
            
            // Make signature draggable
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            
            signatureBox.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                if (e.target === resizeHandle) return;
                initialX = e.clientX - signatureBox.offsetLeft;
                initialY = e.clientY - signatureBox.offsetTop;
                if (e.target === signatureBox || e.target === img) {
                    isDragging = true;
                }
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    signatureBox.style.left = currentX + 'px';
                    signatureBox.style.top = currentY + 'px';
                }
            }
            
            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }
            
            // Make signature resizable
            let isResizing = false;
            
            resizeHandle.addEventListener('mousedown', resizeStart);
            document.addEventListener('mousemove', resizeMove);
            document.addEventListener('mouseup', resizeEnd);
            
            function resizeStart(e) {
                isResizing = true;
                e.stopPropagation();
            }
            
            function resizeMove(e) {
                if (isResizing) {
                    const width = e.clientX - signatureBox.getBoundingClientRect().left;
                    const height = width * (img.naturalHeight / img.naturalWidth);
                    img.style.width = width + 'px';
                    img.style.height = height + 'px';
                }
            }
            
            function resizeEnd() {
                isResizing = false;
            }
            
            // Delete signature
            deleteBtn.addEventListener('click', function() {
                signatureBox.remove();
            });
        }

        // Handle download (remains the same)
        document.getElementById('downloadBtn').addEventListener('click', async function() {
            const canvas = document.getElementById('pdfCanvas');
            const signatureBoxes = document.querySelectorAll('.signature-box');
            
            // Create a new canvas to combine PDF and signatures
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = canvas.width;
            finalCanvas.height = canvas.height;
            const ctx = finalCanvas.getContext('2d');
            
            // Draw the PDF
            ctx.drawImage(canvas, 0, 0);
            
            // Draw all signatures
            signatureBoxes.forEach(box => {
                const img = box.querySelector('img');
                const rect = box.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                
                const x = (rect.left - canvasRect.left) * (canvas.width / canvasRect.width);
                const y = (rect.top - canvasRect.top) * (canvas.height / canvasRect.height);
                const width = img.width * (canvas.width / canvasRect.width);
                const height = img.height * (canvas.height / canvasRect.height);
                
                ctx.drawImage(img, x, y, width, height);
            });
            
            // Convert to PDF and download
            const imgData = finalCanvas.toDataURL('image/jpeg', 1.0);
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'px',
                format: [finalCanvas.width, finalCanvas.height]
            });
            
            pdf.addImage(imgData, 'JPEG', 0, 0, finalCanvas.width, finalCanvas.height);
            pdf.save('signed-document.pdf');
        });
    </script>
</body>
</html>
